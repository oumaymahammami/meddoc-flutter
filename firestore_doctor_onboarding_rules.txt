rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================
    function signedIn() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function getRole(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.role;
    }

    function isAdmin() {
      return signedIn() && getRole(request.auth.uid) == 'admin';
    }

    function isDoctor() {
      return signedIn() && getRole(request.auth.uid) == 'doctor';
    }

    function isPatient() {
      return signedIn() && getRole(request.auth.uid) == 'patient';
    }

    function hasRequiredDoctorFields() {
      let data = request.resource.data;
      return data.keys().hasAll([
        'uid', 'email', 'fullName', 'specialtyId',
        'clinic', 'contacts', 'consultationModes', 'pricing',
        'profileCompleted'
      ])
      && data.fullName is string
      && data.fullName.size() >= 2 && data.fullName.size() <= 100
      && data.specialtyId is string && data.specialtyId.size() > 0
      && data.clinic is map
      && data.clinic.keys().hasAll(['city', 'addressLine'])
      && data.clinic.city is string && data.clinic.city.size() > 0
      && data.clinic.addressLine is string && data.clinic.addressLine.size() > 0
      && data.consultationModes is map
      && (data.consultationModes.inPerson == true || data.consultationModes.video == true)
      && data.pricing is map
      && data.contacts is map
      && (data.contacts.phone is string || data.contacts.email is string);
    }

    function onlyUpdatesSafeFields() {
      let safeFields = [
        'fullName', 'bio', 'specialtyId', 'specialtyName', 
        'requestedSpecialtyId', 'contacts', 'clinic', 
        'consultationModes', 'pricing', 'languages', 
        'acceptingNewPatients', 'photo', 'updatedAt'
      ];
      let changedFields = request.resource.data.diff(resource.data).affectedKeys();
      return changedFields.hasOnly(safeFields);
    }

    // ==================== USERS COLLECTION ====================
    // /users/{uid} - Created at registration with minimal fields
    // Schema: {uid, email, phone, role, profileCompleted, isActive, createdAt, lastLoginAt, updatedAt}
    match /users/{uid} {
      // Doctor can read own user doc
      allow read: if isSelf(uid);
      
      // Admins can read any user doc
      allow read: if isAdmin();

      // Create only at registration
      allow create: if isSelf(uid)
        && request.resource.data.role in ['doctor', 'patient', 'admin']
        && request.resource.data.profileCompleted == false
        && request.resource.data.email is string
        && request.resource.data.email.size() > 0
        && request.resource.data.uid == uid;

      // Doctor can update own profile
      // Immutable: uid, email, createdAt, role (if profileCompleted=true)
      allow update: if isSelf(uid)
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.email == resource.data.email
        && request.resource.data.createdAt == resource.data.createdAt
        && (
          // Allow role change only if profile not yet completed
          (request.resource.data.role != resource.data.role && !resource.data.profileCompleted)
          || request.resource.data.role == resource.data.role
        )
        && (
          // Allow these fields to change
          request.resource.data.phone != resource.data.phone
          || request.resource.data.profileCompleted != resource.data.profileCompleted
          || request.resource.data.isActive != resource.data.isActive
          || request.resource.data.lastLoginAt != resource.data.lastLoginAt
          || request.resource.data.updatedAt != resource.data.updatedAt
        );

      // Admins can update any user
      allow update: if isAdmin();

      // Only admins can delete
      allow delete: if isAdmin();
    }

    // ==================== DOCTORS COLLECTION ====================
    // /doctors/{uid} - Created AFTER profile completion
    // Only editable fields allowed; admin-only fields protected
    match /doctors/{doctorId} {
      // Public visibility: doctor reads own, patients read public profiles
      allow read: if isSelf(doctorId)
        || (isPatient() && resource.data.visibility.isPublic == true)
        || isAdmin();

      // Doctor creates own profile only if /users/{uid}.profileCompleted check passed
      // and required fields present
      allow create: if isSelf(doctorId)
        && isDoctor()
        && get(/databases/$(database)/documents/users/$(doctorId)).data.profileCompleted == true
        && request.resource.data.uid == doctorId
        && request.resource.data.ownerUid == doctorId
        && request.resource.data.profileCompleted == true
        && hasRequiredDoctorFields();

      // Doctor updates only safe fields
      allow update: if isSelf(doctorId)
        && isDoctor()
        && onlyUpdatesSafeFields();

      // Admins can update or delete any doctor profile
      allow update, delete: if isAdmin();
    }

    // ==================== DOCTOR REVIEWS ====================
    // Subcollection of doctors
    match /doctors/{doctorId}/reviews/{reviewId} {
      allow read: if true;
      
      allow create: if isPatient()
        && request.resource.data.patientId == request.auth.uid;
      
      allow update, delete: if isPatient()
        && resource.data.patientId == request.auth.uid;
    }

    // ==================== SPECIALTIES ====================
    // Reference data - read-only for doctors, write for admins
    match /specialties/{specId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // ==================== APPOINTMENTS ====================
    match /appointments/{appointmentId} {
      allow read: if (isDoctor() && resource.data.doctorId == request.auth.uid)
                  || (isPatient() && resource.data.patientId == request.auth.uid)
                  || isAdmin();

      allow create: if isPatient()
        && request.resource.data.patientId == request.auth.uid;

      allow update: if (isDoctor() && resource.data.doctorId == request.auth.uid)
                    || (isPatient() && resource.data.patientId == request.auth.uid)
                    || isAdmin();

      allow delete: if (isPatient() && resource.data.patientId == request.auth.uid)
                    || isAdmin();
    }

    // ==================== PATIENTS ====================
    match /patients/{uid} {
      allow read, create, update: if isSelf(uid) && isPatient();
      allow delete: if isAdmin();
    }

    // ==================== FAVORITES ====================
    match /patients/{patientId}/favorites/{doctorId} {
      allow read, write: if isPatient() && request.auth.uid == patientId;
    }

    // ==================== DEFAULT DENY ====================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
