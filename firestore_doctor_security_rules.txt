rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAdmin() {
      return request.auth.token.admin == true;
    }
    
    function isOwnDoc(uid) {
      return request.auth.uid == uid;
    }
    
    function isSafeField(field) {
      return field in [
        'fullName', 'bio', 'specialtyId', 'specialtyName', 'requestedSpecialtyId',
        'contacts', 'clinic', 'consultationModes', 'pricing', 'languages',
        'acceptingNewPatients', 'photo', 'updatedAt'
      ];
    }
    
    // Doctors collection
    match /doctors/{uid} {
      // Doctors can read their own profile
      allow read: if isOwnDoc(uid) || resource.data.visibility.isPublic == true;
      
      // Doctors can create their own profile
      allow create: if isOwnDoc(uid) && 
                       request.resource.data.uid == uid &&
                       !('verification' in request.resource.data) &&
                       !('visibility' in request.resource.data) &&
                       !('metrics' in request.resource.data) &&
                       !('createdAt' in request.resource.data);
      
      // Doctors can only update their own safe fields
      allow update: if isOwnDoc(uid) && 
                       onlyUpdatesSafeFields() &&
                       !('verification' in request.resource.data.diff.affectedKeys()) &&
                       !('visibility' in request.resource.data.diff.affectedKeys()) &&
                       !('metrics' in request.resource.data.diff.affectedKeys()) &&
                       !('createdAt' in request.resource.data.diff.affectedKeys()) &&
                       !('uid' in request.resource.data.diff.affectedKeys());
      
      // Admins can read, update everything
      allow read, update: if isAdmin();
      
      // Only admins can delete
      allow delete: if isAdmin();
      
      // Helper function to check if only safe fields are being updated
      function onlyUpdatesSafeFields() {
        return request.resource.data.diff.affectedKeys().hasOnly(
          ['fullName', 'bio', 'specialtyId', 'specialtyName', 'requestedSpecialtyId',
           'contacts', 'clinic', 'consultationModes', 'pricing', 'languages',
           'acceptingNewPatients', 'photo', 'updatedAt', 'email']
        );
      }
    }
    
    // Specialties collection
    match /specialties/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Doctor requests (for pending specialty approvals)
    match /doctor_requests/{uid} {
      allow read: if isOwnDoc(uid) || isAdmin();
      allow create, update: if isOwnDoc(uid);
      allow delete: if isAdmin();
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
