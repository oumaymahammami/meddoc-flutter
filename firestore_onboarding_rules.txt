rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- HELPERS ----------
    function signedIn() { 
      return request.auth != null; 
    }

    function isSelf(uid) { 
      return signedIn() && request.auth.uid == uid; 
    }

    function getUserRole(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.role;
    }

    function isAdmin() { 
      return signedIn() && getUserRole(request.auth.uid) == 'admin'; 
    }

    function isDoctor() { 
      return signedIn() && getUserRole(request.auth.uid) == 'doctor'; 
    }

    function isPatient() { 
      return signedIn() && getUserRole(request.auth.uid) == 'patient'; 
    }

    // ---------- USERS (Auth Registration) ----------
    // /users/{uid} created on registration with minimal fields
    // Schema: {uid, email, phone, role, profileCompleted, createdAt, updatedAt}
    match /users/{uid} {
      // Users can read their own profile
      allow read: if isSelf(uid);
      
      // Admins can read all user profiles
      allow read: if isAdmin();

      // Only during registration (create)
      allow create: if isSelf(uid)
        && request.resource.data.role in ['doctor', 'patient']
        && request.resource.data.profileCompleted == false
        && request.resource.data.email != null;

      // Users can update their own profile
      // But can only update phone, role (with restrictions), and profileCompleted
      allow update: if isSelf(uid) 
        && request.resource.data.uid == resource.data.uid  // uid immutable
        && request.resource.data.email == resource.data.email  // email immutable
        && request.resource.data.createdAt == resource.data.createdAt  // createdAt immutable
        && (
          // Allow role change only if they haven't completed profile yet
          (request.resource.data.role != resource.data.role && !resource.data.profileCompleted)
          // Allow phone update
          || request.resource.data.phone != resource.data.phone
          // Allow profileCompleted status change
          || request.resource.data.profileCompleted != resource.data.profileCompleted
        );

      // Admins can update any user profile
      allow update: if isAdmin();

      // Only admins can delete user profiles
      allow delete: if isAdmin();
    }

    // ---------- DOCTORS (Profile Details) ----------
    // /doctors/{uid} created AFTER profileCompleted is true in /users/{uid}
    // doctorId must equal auth.uid
    // Schema: {uid, email, fullName, bio, specialty, clinic, consultationModes, pricing, ...}
    match /doctors/{doctorId} {
      // Public visibility for reading
      allow read: if signedIn() 
        && (
          // Doctor can read own profile
          isSelf(doctorId)
          // Patient can read public profiles
          || (isPatient() && resource.data.visibility.isPublic == true)
        );

      // Doctor can create own profile only if /users/{uid}.profileCompleted was set to true
      allow create: if isSelf(doctorId)
        && isDoctor()
        && get(/databases/$(database)/documents/users/$(doctorId)).data.profileCompleted == true
        && request.resource.data.uid == doctorId;

      // Doctor can update own safe fields only
      allow update: if isSelf(doctorId)
        && isDoctor()
        && onlyUpdatesSafeFields();

      // Admins can update or delete any doctor profile
      allow update, delete: if isAdmin();

      function onlyUpdatesSafeFields() {
        let safeFields = [
          'fullName', 'bio', 'specialtyId', 'specialtyName', 
          'requestedSpecialtyId', 'contacts', 'clinic', 
          'consultationModes', 'pricing', 'languages', 
          'acceptingNewPatients', 'photo'
        ];
        let changedFields = request.resource.data.diff(resource.data).affectedKeys();
        return changedFields.hasOnly(safeFields);
      }
    }

    // ---------- DOCTOR REVIEWS (subcollection) ----------
    match /doctors/{doctorId}/reviews/{reviewId} {
      allow read: if true;
      allow create: if isPatient() 
        && request.resource.data.patientId == request.auth.uid;
      allow update, delete: if isPatient() 
        && resource.data.patientId == request.auth.uid;
    }

    // ---------- SPECIALTIES ----------
    match /specialties/{specId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // ---------- APPOINTMENTS ----------
    match /appointments/{appointmentId} {
      allow read: if (isPatient() && resource.data.patientId == request.auth.uid)
                  || (isDoctor() && resource.data.doctorId == request.auth.uid);
      allow create: if isPatient() 
        && request.resource.data.patientId == request.auth.uid;
      allow update: if (isPatient() && resource.data.patientId == request.auth.uid)
                    || (isDoctor() && resource.data.doctorId == request.auth.uid)
                    || isAdmin();
      allow delete: if (isPatient() && resource.data.patientId == request.auth.uid)
                    || isAdmin();
    }

    // ---------- PATIENTS ----------
    match /patients/{uid} {
      allow read, create, update: if isSelf(uid) && isPatient();
      allow delete: if isAdmin();
    }

    // ---------- FAVORITES ----------
    match /patients/{patientId}/favorites/{doctorId} {
      allow read, write: if isPatient() && request.auth.uid == patientId;
    }

    // ---------- DEFAULT DENY ----------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
